<!DOCTYPE html>
<!-- saved from url=(0067)file:///F:/SAHA%20Project/Program%20Web%20Monitoring/Web/index.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>MODUL OKDJ FLASHER ONLINE</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
:root {
  --primary-color: #FFA500;
  --secondary-color: #4CAF50;
  --danger-color: #f44336;
  --dark-color: #121212;
  --light-color: #f0f0f0;
  --accent-color: #FFC107;
}

body {
  background-color: var(--dark-color);
  color: var(--light-color);
  font-family: 'Segoe UI', Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  margin: 0;
}

header {
  position: fixed;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 10px;
}

.action-button {
  display: inline-block;
  padding: 10px 20px;
  border: none;
  cursor: pointer;
  border-radius: 4px;
  font-weight: bold;
  color: #fff;
  transition: background-color 0.3s;
}

.action-button.flush-btn {
  background-color: var(--primary-color);
}

.action-button.show-all-btn {
  background-color: var(--secondary-color);
}

.action-button.logout-btn {
  background-color: var(--danger-color);
}

.action-button.flush-btn:hover {
  background-color: #FF8C00;
}

.action-button.show-all-btn:hover {
  background-color: #45a049;
}

.action-button.logout-btn:hover {
  background-color: #d32f2f;
}

/* Tambahan: biar tombol-tombol tetap sejajar horizontal */
.action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.folder-box {
  width: 100%;
  max-width: 500px;
  background-color: #1e1e1e;
  border: 1px solid #444;
  border-radius: 8px;
  padding: 10px;
  margin: 10px auto 0 auto;
  overflow-y: auto;
  max-height: 300px;
  text-align: left;
}

.folder-box ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

.folder-box li {
  background: #222;
  margin: 4px 0;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 14px;
  word-break: break-all;
}


/* Container */
.container {
  display: flex;
  justify-content: center;
  width: 90%;
  max-width: 1200px;
  padding: 20px;
  border: 2px solid #333;
  background-color: #1e1e1e;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.left-container,
.right-container {
  flex: 1;
  text-align: center;
}

.left-container {
  margin-right: 20px;
  border-right: 2px solid #444;
  padding-right: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.right-container {
  margin-left: 20px;
  padding-left: 20px;
}

h1 {
  margin-bottom: 20px;
  color: var(--primary-color);
}

label {
  display: block;
  margin-bottom: 10px;
}

input[type="file"] {
  display: none;
}

.upload-btn {
  display: inline-block;
  padding: 10px 20px;
  background-color: var(--secondary-color);
  color: var(--light-color);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.3s;
}

.upload-btn:hover {
  background-color: #45a049;
}

#espList {
  display: block;
  width: 200px;
  margin-bottom: 20px;
}
.esp-input-container {
  width: 100%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  align-items: center;  /* Ini bikin rata tengah */
  margin: 10px auto;
}


.esp-label {
  margin-bottom: 5px;
  font-weight: bold;
  color: var(--primary-color);
}

.esp-input {
  padding: 8px 12px;
  border: 1px solid #555;
  border-radius: 4px;
  background-color: #222;
  color: #fff;
  outline: none;
  transition: border-color 0.3s;
}

.esp-input:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 5px rgba(255, 165, 0, 0.5);
}


.flash-btn {
  display: inline-block;
  padding: 10px 20px;
  background-color: #007bff;
  color: var(--light-color);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.3s;
  margin-bottom: 10px;
}

.flash-btn:hover {
  background-color: #0056b3;
}

.device-info {
  margin: 10px;
  padding: 10px;
  border: 1px solid #333;
  border-radius: 4px;
  display: inline-block;
  background-color: #222;
}

.device-info p {
  margin: 5px 0;
}

.online {
  color: var(--secondary-color);
}

.offline {
  color: var(--danger-color);
}

.signal-strength {
  color: var(--accent-color);
}

#deviceList {
  max-height: 400px;
  overflow-y: auto;
}

.devices-layer {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(10px);
  z-index: 999;
  padding: 20px;
}

.devices-layer .devices-container {
  max-height: 90%;
  overflow-y: auto;
}

.devices-layer button {
  display: inline-block;
  padding: 10px 20px;
  background-color: var(--danger-color);
  color: var(--light-color);
  border: none;
  cursor: pointer;
  border-radius: 4px;
  font-weight: bold;
  transition: background-color 0.3s;
}

.devices-layer button:hover {
  background-color: #d32f2f;
}

a {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: bold;
  margin-left: 10px;
}

a:hover {
  color: #FF8C00;
}

.header {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 20px;
}

.header p,
.header a {
  margin: 0;
}

.header .spacer {
  margin-left: 20px;
}

.device-info .command-btn {
  background-color: #4CAF50;
  color: #fff;
  padding: 5px 10px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}

.serial-layer,
.command-layer {
  z-index: 1000;
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.serial-content,
.command-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #333;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
  color: #fff;
}

.serial-content h3,
.command-content h3 {
  margin: 0;
  color: #fff;
}

.command-content input {
  width: 100%;
  padding: 5px;
  margin-bottom: 10px;
  background-color: #fff;
  color: #333;
}

.serial-content button,
.command-content button {
  background-color: #4CAF50;
  color: #fff;
  padding: 8px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}

#serialOutput {
  white-space: pre-wrap;
  overflow: auto;
  max-height: 300px;
  border: 1px solid #444;
  padding: 10px;
  font-family: monospace;
  background-color: #000;
  color: #0f0;
  border-radius: 8px;
}

#selectedDevice,
#selectedDeviceCmd {
  font-weight: bold;
}
/* Styling untuk scroll di device list & container */
#deviceList::-webkit-scrollbar,
.devices-layer .devices-container::-webkit-scrollbar {
  width: 8px; /* Lebar scrollbar */
}

#deviceList::-webkit-scrollbar-track,
.devices-layer .devices-container::-webkit-scrollbar-track {
  background: #3a3a3a; /* Warna track */
  border-radius: 4px;
}

#deviceList::-webkit-scrollbar-thumb,
.devices-layer .devices-container::-webkit-scrollbar-thumb {
  background-color: var(--accent-color); /* Warna handle */
  border-radius: 4px;
  border: 2px solid #1e1e1e; /* Biar handle kelihatan smooth */
}

#deviceList::-webkit-scrollbar-thumb:hover,
.devices-layer .devices-container::-webkit-scrollbar-thumb:hover {
  background-color: ##3a3a3a; /* Warna handle pas hover */
}

.device-info.highlighted-device {
  background-color: #3a3a3a; /* abu yang lebih terang & soft */
  color: #f0f0f0;           /* teks putih keabuan */
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}



.device-info p.device-title {
  font-weight: 700;
  color: #f0f0f0;  /* teks hitam */
  font-size: 1.05em;
  margin-bottom: 6px;
}


@media screen and (max-width: 600px) {
  .container {
    flex-direction: column;
    align-items: stretch;
  }
  .left-container {
    margin-left: 20px;
    margin-top: 20px;
    border-right: none;
    padding-right: 0;
  }
  .right-container {
    text-align: center;
    margin-left: -20px;
    margin-top: 20px;
  }
  .action-buttons {
    flex-direction: column;
  }




  
}



      </style>
   </head>
   <body>
      <div class="overlay"></div>
      <!-- Hamburger menu for action buttons -->
      <div class="hamburger-menu" onclick="toggleActionButtons()">
         <span></span>
         <span></span>
         <span></span>
      </div>
      <!-- Action buttons for non-smartphone view -->
      <div class="action-buttons">
         <label class="action-button flush-btn" onclick="promptPasswordAndFlushAll()">Hapus Semua Modul Terdaftar</label>
         <label class="action-button show-all-btn" onclick="toggleRegisteredDevices()">Tampilkan Semua Modul</label>
         <label class="action-button logout-btn" onclick="logout()">Logout</label>
      </div>
      <div class="container">
         <section class="left-container">
            <div id="notification" style="display: none;"></div>
            <h1>ARF TECH UPDATE ONLINE</h1>

<label class="upload-btn" for="folderInput">Buka Folder</label>
<input type="file" id="folderInput" webkitdirectory="" directory="" multiple="">

<div class="folder-box">
  <ul id="folderContents"></ul>

</div>

    <br>

<label class="upload-btn" for="firmware">Upload Firmware</label>

<input type="file" id="firmware" name="firmwareFile" accept=".bin" onchange="showSelectedFileName(this)">
<div class="folder-box">
  <span id="firmwareFileName"></span>
</div>
   <br>
   
<div class="esp-input-container">
  <label for="espList" class="esp-label">Pilih Modul :</label>
  <input list="espOptions" id="espList" onchange="fetchFirmwareVersion()" placeholder="Ketik nama modul..." class="esp-input">
  <datalist id="espOptions"></datalist>
</div>



            <br>
            <label id="firmwareVersion">Versi Modul: N/A</label><br>
            <button class="flash-btn" onclick="promptPasswordAndFlash()">Flash Firmware</button>
            <div id="flashMessageContainer"></div>
   <button class="flash-btn" onclick="promptPasswordAndFlashSpiffs()">Flash SPIFFS</button>



         </section>
         <section class="right-container">

            <h2>MODUL TERDAFTAR :</h2>
            <div>
               <p>Jumlah Modul Terdaftar : <span id="totalDevicesCount">0</span></p>
               <p>Jumlah Modul Online : <span id="onlineDevicesCount">0</span></p>
               <p>Jumlah Modul Offline: <span id="offlineDevicesCount">0</span></p>
            </div>
            <div id="deviceList">
               <!-- Device status and firmware version will be dynamically added here -->
            </div>
            <div class="devices-layer" id="devicesLayer">
                        <div class="devices-container">
                            <!-- Dynamically display all registered devices here -->
                        </div>
                        <button onclick="toggleRegisteredDevices()">Close</button>
                    </div>
            <!-- Serial Monitor Layer -->
            <div class="serial-layer" id="serialLayer">
               <div class="serial-content">
                  <h3>Serial Monitor for <span id="selectedDevice"></span></h3>
                  <pre id="serialOutput"></pre>
                  <button onclick="closeSerialMonitor()">Close</button>
               </div>
            </div>
            <!-- Send Command Layer -->
            <div class="command-layer" id="commandLayer">
               <div class="command-content">
                  <h3>Send Command to <span id="selectedDeviceCmd"></span></h3>
                  <input type="text" id="commandInput" placeholder="Enter your command...">
                  <button onclick="sendCommand()">Send</button>
                  <button onclick="closeSendCommand()">Cancel</button>

               </div>
            </div>
         </section>
      </div>
      <div class="header">
         
         <span class="spacer"></span>
         <p id="serverVersion">Server Version: Loading...</p>
      </div>
      <script>
	  function promptPasswordAndFlashSpiffs() {
  const password = prompt('Enter password for SPIFFS Flash:');
  if (!password) return; // Cancelled

  fetch('/authenticate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password })
  })
  .then(response => {
    if (response.ok) {
      flashSpiffs();
    } else {
      alert('Incorrect password. SPIFFS flashing canceled.');
    }
  })
  .catch(error => console.error('Error authenticating password:', error));
}
function flashSpiffs() {
  const selectedESP = document.getElementById('espList').value;
  if (!selectedESP) {
    alert('Please select an ESP device.');
    return;
  }

  // Kirim perintah "downloadAndFlashSpiffs" ke server, nanti ESP32 polling dan eksekusi sendiri
  fetch('/sendCommand', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      hostName: selectedESP,
      command: "downloadAndFlashSpiffs"
    })
  })
    .then(response => {
      if (response.ok) {
        alert('Command "downloadAndFlashSpiffs" sent successfully!');
      } else {
        alert('Failed to send SPIFFS flash command.');
      }
    })
    .catch(error => console.error('Error sending SPIFFS flash command:', error));

}


	    function showSelectedFileName(input) {
    const fileNameSpan = document.getElementById('firmwareFileName');
    if (input.files.length > 0) {
      fileNameSpan.textContent = `File dipilih: ${input.files[0].name}`;
    } else {
      fileNameSpan.textContent = 'Belum ada file terpilih';
    }
  }
document.getElementById('folderInput').addEventListener('change', async (event) => {
  const files = event.target.files;
  const list = document.getElementById('folderContents');
  list.innerHTML = "";

  if (files.length === 0) {
    alert("Please select a folder!");
    return;
  }

  // ðŸ§¹ Kirim request ke server untuk hapus semua isi folder data/
  await fetch('/clearDataFolder', { method: 'POST' });

  for (const file of files) {
    const cleanPath = file.webkitRelativePath.replace(/^data\//, '');
    const kbSize = (file.size / 1024).toFixed(2);
    const item = document.createElement('li');
    item.textContent = `${cleanPath} (${kbSize} KB)`;
    list.appendChild(item);

    // Upload langsung
    try {
      const response = await fetch(`/uploadFile?path=${encodeURIComponent(file.webkitRelativePath)}`, {
        method: "POST",
        body: file
      });
      const result = await response.text();
      console.log(`Uploaded: ${cleanPath}, result: ${result}`);
    } catch (err) {
      console.error(`Error uploading ${cleanPath}:`, err);
    }
  }
});

  
         const flashMessageContainer = document.getElementById('flashMessageContainer');
                  // JavaScript function to toggle the hamburger menu and action buttons in smartphone mode
         function toggleActionButtons() {
         const hamburgerMenu = document.querySelector('.hamburger-menu');
         const actionButtons = document.querySelector('.action-buttons');
         const overlay = document.querySelector('.overlay'); // Add this line to select the overlay element
         
         hamburgerMenu.classList.toggle('open');
         actionButtons.classList.toggle('open');
         overlay.classList.toggle('active'); // Toggle the 'active' class on the overlay element
         }
         // Function to display the "OTA" message for 5 seconds and then remove it
         function displayFlashMessage(message) {
           flashMessageContainer.textContent = message;
           setTimeout(() => {
             flashMessageContainer.textContent = '';
           }, 5000); // Remove the message after 5000 milliseconds (5 seconds)
         }
         
         fetch('/getWebSocketAddress')
           .then(response => response.json())
           .then(data => {
             const wsAddress = `ws://${data.ip}:${data.port}`;
             const ws = new WebSocket(wsAddress);
         
             ws.onmessage = (event) => {
               const message = event.data;
               displayFlashMessage(message); // Display the received message
             };
           })
function removeDevice(hostName) {
  if (!confirm(`Are you sure you want to remove device "${hostName}"?`)) {
    return;
  }

  // Kirim request hapus ke server
  fetch('/removeDevice', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ hostName: hostName })
  })
  .then(response => {
    if (response.ok) {
      alert(`Device "${hostName}" removed successfully.`);
      closeSendCommand(); // Tutup popup kalau Remove dipanggil dari layer
      fetchRegisteredDevices();
      fetchDeviceStatus();
    } else {
      alert('Failed to remove device.');
    }
  })
  .catch(error => console.error('Error removing device:', error));
}


                // Function to fetch registered ESP devices and populate the dropdown list
function fetchRegisteredDevices() {
  fetch('/getDevices')
    .then(response => response.json())
    .then(data => {
      const espOptions = document.getElementById('espOptions');
      espOptions.innerHTML = ''; // Clear existing list

      data.forEach(device => {
        const option = document.createElement('option');
        option.value = device;
        espOptions.appendChild(option);
      });
    })
    .catch(error => console.error('Error fetching devices:', error));
}

                
                // Function to fetch firmware version for the selected ESP
function fetchFirmwareVersion() {
  const selectedESP = document.getElementById('espList').value;
  if (!selectedESP) {
    return;
  }

  fetch('/getFirmwareVersion?hostName=' + encodeURIComponent(selectedESP))
    .then(response => response.text())
    .then(version => {
      const firmwareVersionLabel = document.getElementById('firmwareVersion');
      firmwareVersionLabel.innerText = 'Versi Modul : ' + version;
    })
    .catch(error => console.error('Error fetching firmware version:', error));
}

                
                // Function to upload firmware to the Node.js server and initiate firmware flashing
                function uploadAndFlashFirmware() {
                    const fileInput = document.getElementById('firmware');
                    const selectedFile = fileInput.files[0];
                    if (!selectedFile) {
                        alert('Please select a firmware file.');
                        return;
                    }
                
                    const formData = new FormData();
                    formData.append('firmwareFile', selectedFile);
                
                    const selectedESP = espList.value;
                    if (!selectedESP) {
                        alert('Please select an ESP from the list.');
                        return;
                    }
                
                    fetch('/upload?hostName=' + encodeURIComponent(selectedESP), {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
         if (response.ok) {
         // Display a success message
         const notification = document.getElementById('notification');
         notification.innerHTML = 'Firmware upload successful. Starting OTA update...';
         notification.style.backgroundColor = 'green';
         notification.style.display = 'block';
         
         // Start the OTA update after a brief delay (e.g., 2 seconds)
         setTimeout(() => {
         fetch('/flash-firmware?hostName=' + encodeURIComponent(selectedESP))
            .then(response => {
                if (response.ok) {
                    // Optionally, you can display another success message here
                } else {
                    // Optionally, display an error message here
                }
            })
            .catch(error => console.error('Error initiating firmware flashing:', error));
         
         // Hide the notification after the OTA update is initiated
         notification.style.display = 'none';
         }, 2000); // Adjust the delay as per your requirement
         } else {
         // Display an error message
         const notification = document.getElementById('notification');
         notification.innerHTML = 'Firmware upload failed.';
         notification.style.backgroundColor = 'red';
         notification.style.display = 'block';
         }
                        })
                        .catch(error => console.error('Error uploading firmware:', error));
                }
                
                // Function to fetch online status and firmware version for all registered devices
function fetchDeviceStatus() {
  fetch('/getOnlineStatus')
    .then(response => response.json())
    .then(deviceStatusList => {
      const deviceList = document.getElementById('deviceList');
      const totalDevicesCount = document.getElementById('totalDevicesCount');
      const onlineDevicesCount = document.getElementById('onlineDevicesCount');
      const offlineDevicesCount = document.getElementById('offlineDevicesCount');

      deviceList.innerHTML = ''; // Clear existing list

      let deviceCounter = 0;
      let onlineCounter = 0;
      let offlineCounter = 0;

      deviceStatusList.forEach(deviceStatus => {
        appendDeviceInfo(deviceList, deviceStatus);
        deviceCounter++;

        if (deviceStatus.online) {
          onlineCounter++;
        } else {
          offlineCounter++;
        }
      });

      totalDevicesCount.innerText = deviceCounter;
      onlineDevicesCount.innerText = onlineCounter;
      offlineDevicesCount.innerText = offlineCounter;
    })
    .catch(error => console.error('Error fetching device status:', error));
}

                
         // Function to append device information to the deviceList div
         function appendDeviceInfo(deviceList, deviceStatus) {
            const deviceInfo = document.createElement('div');
            deviceInfo.classList.add('device-info');
            deviceInfo.innerHTML = `
<div class="device-info highlighted-device">
  <p class="device-title">${deviceStatus.device}</p>

</div>




                <p>Status: <span class="${deviceStatus.online ? 'online' : 'offline'}">${deviceStatus.online ? 'Online' : 'Offline'}</span></p>
                <p>Versi Modul : ${deviceStatus.firmwareVersion}</p>
                <p>Signal: <span class="signal-strength">${deviceStatus.wifiSignalStrength !== undefined ? deviceStatus.wifiSignalStrength : 'N/A'}</span></p>
<!--
<p>MAC: ${deviceStatus.macAddress}</p>
<p>IP Address: ${deviceStatus.ipAddress !== undefined ? deviceStatus.ipAddress : 'N/A'}</p>
-->

<div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
  <button class="command-btn" onclick="openSendCommand('${deviceStatus.device}')">Send Command</button>
  <button class="command-btn" style="background-color: red;" onclick="removeDevice('${deviceStatus.device}')">Hapus</button>
</div>
 `;
            deviceList.appendChild(deviceInfo);
         }                
                // Function to toggle the devices layer visibility
                function toggleRegisteredDevices() {
                const devicesLayer = document.getElementById('devicesLayer');
                const showAllBtn = document.querySelector('.show-all-btn');
                
                if (devicesLayer.style.display === 'block') {
                devicesLayer.style.display = 'none';
                } else {
                devicesLayer.style.display = 'block';
                }
                }
                
                
                // Function to populate the devices layer with all registered devices and refresh every 10 seconds
                function populateDevicesLayer() {
                    const devicesLayer = document.getElementById('devicesLayer');
                    devicesLayer.innerHTML = `
                        <div class="devices-container">
                            <!-- Dynamically display all registered devices here -->
                        </div>
                        <button onclick="toggleRegisteredDevices()">Close</button>
                    `;
                
                    const devicesContainer = devicesLayer.querySelector('.devices-container');
                
                    // Function to update the devices layer with device information
                    function updateDevicesLayer() {
                        fetch('/getOnlineStatus')
                            .then(response => response.json())
                            .then(deviceStatusList => {
                                devicesContainer.innerHTML = ''; // Clear existing list
                                deviceStatusList.forEach(deviceStatus => {
                                    appendDeviceInfo(devicesContainer, deviceStatus);
                                });
                            })
                            .catch(error => console.error('Error fetching device status:', error));
                    }
                
                    // Call the updateDevicesLayer function initially
                    updateDevicesLayer();
                
                    // Set interval to update the devices layer every 10 seconds
                    setInterval(updateDevicesLayer, 10000);
                }
                         // Function to prompt password and flash firmware
                function promptPasswordAndFlash() {
                   const password = prompt('Enter password:'); // Prompt the user for password
                
                   if (password === null || password === '') {
                      // User canceled or entered an empty password
                      return;
                   }
                
                   // Send the password to the Node.js server for authentication
                   fetch('/authenticate', {
                      method: 'POST',
                      headers: {
                         'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({ password: password })
                   })
                   .then(response => {
                      if (response.ok) {
                         // Password is correct, proceed with firmware flashing
                         uploadAndFlashFirmware();
                      } else {
                         // Password is incorrect, show an error message
                         alert('Incorrect password. Firmware flashing canceled.');
                      }
                   })
                   .catch(error => console.error('Error authenticating password:', error));
                }
                // Function to prompt password and flush all devices
                function promptPasswordAndFlushAll() {
                   const password = prompt('Enter password:'); // Prompt the user for password
                
                   if (password === null || password === '') {
                      // User canceled or entered an empty password
                      return;
                   }
                
                   // Send the password to the Node.js server for authentication
                   fetch('/authenticate', {
                      method: 'POST',
                      headers: {
                         'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({ password: password })
                   })
                   .then(response => {
                      if (response.ok) {
                         // Password is correct, proceed with flushing all devices
                         flushAllDevices();
                      } else {
                         // Password is incorrect, show an error message
                         alert('Incorrect password. Flushing all devices canceled.');
                      }
                   })
                   .catch(error => console.error('Error authenticating password:', error));
                }
                // Function to prompt password and flush all devices
                function promptPasswordAndFlushAll() {
                   const password = prompt('Enter password:'); // Prompt the user for password
                
                   if (password === null || password === '') {
                      // User canceled or entered an empty password
                      return;
                   }
                
                   // Send the password to the Node.js server for authentication
                   fetch('/authenticate', {
                      method: 'POST',
                      headers: {
                         'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({ password: password })
                   })
                   .then(response => {
                      if (response.ok) {
                         // Password is correct, proceed with flushing all devices
                         flushAllDevices();
                      } else {
                         // Password is incorrect, show an error message
                         alert('Incorrect password. Flushing all devices canceled.');
                      }
                   })
                   .catch(error => console.error('Error authenticating password:', error));
                }
                // Call the fetchRegisteredDevices and fetchDeviceStatus functions on page load
                fetchRegisteredDevices();
                fetchDeviceStatus();
                
                // Set interval to update device status every 10 seconds
                setInterval(fetchDeviceStatus, 10000);
                
                   // Function to flush all registered devices
                function flushAllDevices() {
                   fetch('/flushAllDevices', {
                      method: 'POST'
                   })
                   .then(response => {
                      if (response.ok) {
                         alert('All registered devices have been flushed.');
                         fetchRegisteredDevices();
                         fetchDeviceStatus();
                      } else {
                         alert('Failed to flush registered devices.');
                      }
                   })
                   .catch(error => console.error('Error flushing registered devices:', error));
                }
                
                // Call the function to populate the devices layer when the page loads
                populateDevicesLayer();
                function logout() {
                    fetch('/logout', {
                        method: 'POST'
                    })
                        .then(response => {
                            if (response.ok) {
                                window.location.href = '/'; // Redirect to the login page
                            }
                        })
                        .catch(error => console.error('Error logging out:', error));
                }
         // Add a function to fetch the server version and display it on the page
         async function fetchServerVersion() {
         try {
         const response = await fetch('/getServerVersion');
         if (response.ok) {
         const serverVersion = await response.text();
         const versionElement = document.getElementById('serverVersion');
         versionElement.textContent = `Server Version: ${serverVersion}`;
         } else {
         console.error('Failed to fetch server version:', response.status, response.statusText);
         }
         } catch (error) {
         console.error('Error fetching server version:', error.message);
         }
         }
         // Add an event listener to the "Select ESP" dropdown list to call fetchRegisteredDevices
         document.addEventListener('DOMContentLoaded', () => {
            const espDropdown = document.getElementById('espList');
            let isFocused = false;
         
            // For Chrome and other browsers
            espDropdown.addEventListener('focus', () => {
               isFocused = true;
               fetchRegisteredDevices();
            });
         
            espDropdown.addEventListener('blur', () => {
               isFocused = false;
            });
         
            // For Firefox
            if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1) {
               espDropdown.addEventListener('click', (event) => {
                  if (isFocused) {
                     event.preventDefault();
                     event.stopPropagation();
                     espDropdown.focus();
                  }
               });
            }
         });
         // Add the following JavaScript code for the "Send Command" functionality
         function openSendCommand(hostName) {
         const commandLayer = document.getElementById('commandLayer');
         const selectedDeviceCmd = document.getElementById('selectedDeviceCmd');
         
         selectedDeviceCmd.textContent = hostName;
         document.getElementById('commandInput').value = '';
         
         // Display the send command layered screen
         commandLayer.style.display = 'block';
         }
         
         function closeSendCommand() {
         const commandLayer = document.getElementById('commandLayer');
         
         // Hide the send command layered screen
         commandLayer.style.display = 'none';
         }
         
         function sendCommand() {
         const commandInput = document.getElementById('commandInput');
         const command = commandInput.value.trim();
         const selectedDeviceCmd = document.getElementById('selectedDeviceCmd');
         
         if (command) {
         const hostName = selectedDeviceCmd.textContent;
         
         // Send the command to the selected device
         console.log(`Sending command "${command}" to device "${hostName}"`);
         
         // Send the command using the Fetch API
         fetch('/sendCommand', {
         method: 'POST',
         headers: {
          'Content-Type': 'application/json'
         },
         body: JSON.stringify({ hostName: hostName, command: command })
         })
         .then(response => {
         if (response.ok) {
          console.log('Command sent successfully.');
          // Add any additional code here if needed after sending the command successfully
         } else {
          console.error('Failed to send command:', response.status, response.statusText);
          // Handle any error if necessary
         }
         })
         .catch(error => console.error('Error sending command:', error));
         
         // Clear the input field
         commandInput.value = '';
         closeSendCommand();
         }
         }
         
         // Call the fetchServerVersion function when the page is loaded
         document.addEventListener('DOMContentLoaded', fetchServerVersion);

      </script>
   
</body></html>